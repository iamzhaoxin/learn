"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderOption=renderOption,exports.renderOptgroup=renderOptgroup,exports.default=void 0;var _input=_interopRequireDefault(require("../../input/src/input")),_conf=_interopRequireDefault(require("../../conf")),_util=require("./util"),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function findOffsetOption(e,t,i){for(var o,n,l=!1,s=0;s<e.length;s++){var a=e[s];if(a.options)for(var r=0;r<a.options.length;r++){var p=a.options[r];if(n||(n=p),i){if(t===p.value)return{offsetOption:o,firstOption:n}}else{if(l)return{offsetOption:p,firstOption:n};t===p.value&&(l=!0)}o=p}else{if(n||(n=a),i){if(t===a.value)return{offsetOption:o,firstOption:n}}else{if(l)return{offsetOption:a,firstOption:n};t===a.value&&(l=!0)}o=a}}return{firstOption:n}}function findOption(e,t){for(var i=0;i<e.length;i++){var o=e[i];if(o.options)for(var n=0;n<o.options.length;n++){var l=o.options[n];if(t===l.value)return l}else if(t===o.value)return o}}function renderOption(l,s,e,a){var r=s.optkey,p=s.value,u=s.currentValue,t=s.optionGroupProps,i=void 0===t?{}:t,o=s.optionProps,n=void 0===o?{}:o,d=i.disabled||"disabled",f=n.label||"label",h=n.value||"value",c=n.disabled||"disabled";return e?e.map(function(e,t){var i=a&&a[d]||e[c],o=e[h],n=(0,_util.getOptid)(s,e);return l("div",{key:r?n:t,class:["vxe-select-option",{"is--disabled":i,"is--checked":p===o,"is--hover":u===o}],attrs:{"data-optid":n},on:{click:function(e){i||s.changeOptionEvent(e,o)},mouseenter:function(){i||s.setCurrentOption({value:o})}}},_tools.UtilTools.formatText(_tools.UtilTools.getFuncText(e[f])))}):[]}function renderOptgroup(o,n){var l=n.optkey,e=n.optionGroups,t=n.optionGroupProps,i=void 0===t?{}:t,s=i.options||"options",a=i.label||"label",r=i.disabled||"disabled";return e?e.map(function(e,t){var i=(0,_util.getOptid)(n,e);return o("div",{key:l?i:t,class:["vxe-optgroup",{"is--disabled":e[r]}],attrs:{"data-optid":i}},[o("div",{class:"vxe-optgroup--title"},_tools.UtilTools.getFuncText(e[a])),o("div",{class:"vxe-optgroup--wrapper"},renderOption(o,n,e[s],e))])}):[]}var _default2={name:"VxeSelect",props:{value:null,clearable:Boolean,placeholder:String,disabled:Boolean,prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},optId:{type:String,default:function(){return _conf.default.select.optId}},optKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},components:{VxeInput:_input.default},provide:function(){return{$xeselect:this}},data:function(){return{updateFlag:0,panelIndex:0,optionList:[],allOptList:[],panelStyle:null,panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},selectLabel:function(){var e=findOption(this.allOptList,this.value);return e?e.label:this.value}},watch:{options:function(){this.updateCache(),this.updateOptComps()},optionGroups:function(){this.updateCache(),this.updateOptComps()},updateFlag:function(){this.updateOptComps()}},created:function(){(this.options||this.optionGroups)&&(this.updateCache(),this.updateOptComps()),_tools.GlobalEvent.on(this,"mousewheel",this.handleGlobalMousewheelEvent),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},mounted:function(){this.transfer&&document.body.appendChild(this.$refs.panel)},beforeDestroy:function(){var e=this.$refs.panel;e&&e.parentNode&&e.parentNode.removeChild(e)},destroyed:function(){_tools.GlobalEvent.off(this,"mousewheel"),_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"blur")},render:function(e){var t,i,o=this.vSize,n=this.transfer,l=this.isActivated,s=this.disabled,a=this.clearable,r=this.placeholder,p=this.selectLabel,u=this.animatVisible,d=this.visiblePanel,f=this.panelStyle,h=this.prefixIcon,c=this.panelPlacement,v=this.optionGroups;return e("div",{class:["vxe-select",(t={},_defineProperty(t,"size--".concat(o),o),_defineProperty(t,"is--visivle",d),_defineProperty(t,"is--disabled",s),_defineProperty(t,"is--active",l),t)]},[e("vxe-input",{ref:"input",props:{clearable:a,placeholder:r,readonly:!0,disabled:s,type:"text",prefixIcon:h,suffixIcon:d?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,value:p},on:{clear:this.clearEvent,click:this.togglePanelEvent,focus:this.focusEvent,blur:this.blurEvent,"suffix-click":this.togglePanelEvent}}),e("div",{ref:"panel",class:["vxe-table--ignore-clear vxe-select--panel",(i={},_defineProperty(i,"size--".concat(o),o),_defineProperty(i,"is--transfer",n),_defineProperty(i,"animat--leave",u),_defineProperty(i,"animat--enter",d),i)],attrs:{"data-placement":c},style:f},[e("div",{ref:"optWrapper",class:"vxe-select-option--wrapper"},this.$slots.default||(v?renderOptgroup(e,this):renderOption(e,this,this.options)))])])},methods:{updateOptions:function(){this.updateFlag++},updateCache:function(){var t=this,e=this.options,i=this.optionGroups,o=this.optionGroupProps,n=(void 0===o?{}:o).options||"options";if(i||e){var l=(0,_util.getOptkey)(this),s=function(e){(0,_util.getOptid)(t,e)||(e[l]=(0,_util.getOptUniqueId)())};i?i.forEach(function(e){s(e),e[n]&&e[n].forEach(s)}):e.forEach(s)}},updateOptComps:function(){var s=this,e=this.options,t=this.optionGroups,a=[],r=[];if(t||e){var i=this.optionProps,o=void 0===i?{}:i,n=this.optionGroupProps,l=void 0===n?{}:n,p=o.disabled||"disabled",u=o.label||"label",d=o.value||"value";if(t){var f=l.options||"options",h=l.label||"label",c=l.disabled||"disabled";t.forEach(function(o){var n=[],l=[];o[f].forEach(function(e){var t=o&&o[c]||e[p],i={label:e[u],value:e[d],disabled:t,id:(0,_util.getOptid)(s,e)};t||n.push(i),l.push(i)}),n.length&&a.push({label:o[h],disabled:o[c],options:n,id:(0,_util.getOptid)(s,o)}),l.length&&r.push({label:o[h],disabled:o[c],options:l,id:(0,_util.getOptid)(s,o)})})}else e.forEach(function(e){var t=e[p],i={label:e[u],value:e[d],disabled:t,id:(0,_util.getOptid)(s,e)};t||a.push(i),r.push(i)});return this.optionList=a,this.allOptList=r,Promise.resolve()}return this.$nextTick().then(function(){s.$children.forEach(function(e){if(e.$xeselect){var i=[],o=[],t=e.$children.length;if(e.$children.forEach(function(e){if(e.$xeselect&&e.$xeoptgroup){var t={label:e.label,value:e.value,disabled:e.isDisabled,id:e.id};e.isDisabled||i.push(t),o.push(t)}}),t)i.length&&a.push({label:e.label,disabled:e.disabled,options:i,id:e.id}),o.length&&r.push({label:e.label,disabled:e.disabled,options:o,id:e.id});else{var n={label:e.label,value:e.value,disabled:e.disabled,id:e.id};e.disabled||a.push(n),r.push(n)}}}),s.optionList=a,s.allOptList=r})},setCurrentOption:function(e){e&&(this.currentValue=e.value)},scrollToOption:function(l,s){var a=this;return new Promise(function(n){if(l)return a.$nextTick().then(function(){var e=a.$refs,t=e.optWrapper,i=e.panel.querySelector("[data-optid='".concat(l.id,"']"));if(t&&i){var o=t.offsetHeight;s?i.offsetTop+i.offsetHeight-t.scrollTop>o&&(t.scrollTop=i.offsetTop+i.offsetHeight-o):i.offsetTop-5<t.scrollTop&&(t.scrollTop=i.offsetTop-5)}n()});n()})},clearEvent:function(e,t){this.clearValueEvent(t,null),this.hideOptionPanel()},clearValueEvent:function(e,t){this.changeEvent(e,t),this.$emit("clear",{value:t,$event:e})},changeEvent:function(e,t){t!==this.value&&(this.$emit("input",t),this.$emit("change",{value:t,$event:e}))},changeOptionEvent:function(e,t){this.changeEvent(e,t),this.hideOptionPanel()},handleGlobalMousewheelEvent:function(e){var t=this.$refs,i=this.$el,o=this.disabled,n=this.visiblePanel;if(!o&&n){var l=_tools.DomTools.getEventTargetNode(e,i).flag;l||_tools.DomTools.getEventTargetNode(e,t.panel).flag?l&&this.updatePlacement():this.hideOptionPanel()}},handleGlobalMousedownEvent:function(e){var t=this.$refs,i=this.$el,o=this.disabled,n=this.visiblePanel;o||(this.isActivated=_tools.DomTools.getEventTargetNode(e,i).flag||_tools.DomTools.getEventTargetNode(e,t.panel).flag,n&&!this.isActivated&&this.hideOptionPanel())},handleGlobalKeydownEvent:function(e){var t=this.visiblePanel,i=this.currentValue,o=this.clearable;if(!this.disabled){var n=e.keyCode,l=9===n,s=13===n,a=27===n,r=38===n,p=40===n,u=46===n,d=32===n;if(l&&(this.isActivated=!1),t)if(a||l)this.hideOptionPanel();else if(s)this.changeOptionEvent(e,i);else if(r||p){e.preventDefault();var f=this.optionList,h=findOffsetOption(f,i,r),c=h.offsetOption,v=h.firstOption;c||findOption(f,i)||(c=v),this.setCurrentOption(c),this.scrollToOption(c,p)}else d&&e.preventDefault();else(r||p||s||d)&&this.isActivated&&(e.preventDefault(),this.showOptionPanel());this.isActivated&&u&&o&&this.clearValueEvent(e,null)}},handleGlobalBlurEvent:function(){this.hideOptionPanel()},updateZindex:function(){this.panelIndex<_tools.UtilTools.getLastZIndex()&&(this.panelIndex=_tools.UtilTools.nextZIndex())},focusEvent:function(){this.disabled||(this.isActivated=!0)},blurEvent:function(){this.isActivated=!1},togglePanelEvent:function(e){e.$event.preventDefault(),this.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},showOptionPanel:function(){var t=this;this.disabled||(clearTimeout(this.hidePanelTimeout),this.isActivated=!0,this.animatVisible=!0,setTimeout(function(){var e=findOption(t.allOptList,t.value);t.visiblePanel=!0,e&&(t.setCurrentOption(e),t.scrollToOption(e))},10),this.updateZindex(),this.updatePlacement())},hideOptionPanel:function(){var e=this;this.visiblePanel=!1,this.hidePanelTimeout=setTimeout(function(){e.animatVisible=!1},200)},updatePlacement:function(){var _=this;return this.$nextTick().then(function(){var e=_.$refs,t=_.transfer,i=_.placement,o=_.panelIndex,n=e.input.$el,l=e.panel,s=n.offsetHeight,a=n.offsetWidth,r=l.offsetHeight,p=l.offsetWidth,u={zIndex:o},d=_tools.DomTools.getAbsolutePos(n),f=d.boundingTop,h=d.boundingLeft,c=d.visibleHeight,v=d.visibleWidth,b="bottom";if(t){var O=h,g=f+s;"top"===i?(b="top",g=f-r):(c<g+r+5&&(b="top",g=f-r),g<5&&(b="bottom",g=f+s)),v<O+p+5&&(O-=O+p+5-v),O<5&&(O=5),Object.assign(u,{left:"".concat(O,"px"),top:"".concat(g,"px"),minWidth:"".concat(a,"px")})}else"top"===i?(b="top",u.bottom="".concat(s,"px")):c<f+s+r&&(b="top",u.bottom="".concat(s,"px"));return _.panelStyle=u,_.panelPlacement=b,_.$nextTick()})},focus:function(){return this.showOptionPanel(),this.$nextTick()},blur:function(){return this.hideOptionPanel(),this.$nextTick()}}};exports.default=_default2;