{"remainingRequest":"D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\babel-loader\\lib\\index.js!D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\src\\views\\system\\modules\\SysCheckRuleModal.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\src\\views\\system\\modules\\SysCheckRuleModal.vue","mtime":1611914356000},{"path":"D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1621061384845},{"path":"D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\babel-loader\\lib\\index.js","mtime":1621061377995},{"path":"D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1621061384845},{"path":"D:\\activiti\\project01\\jeecg-boot-activiti-master\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js","mtime":1621061372054}],"contextDependencies":[],"result":["function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport pick from 'lodash.pick';\nimport { httpAction } from '@/api/manage';\nimport { validateDuplicateValue, alwaysResolve, failedSymbol } from '@/utils/util';\nimport { FormTypes } from '@/utils/JEditableTableUtil';\nimport JEditableTable from '@comp/jeecg/JEditableTable';\nexport default {\n  name: 'SysCheckRuleModal',\n  components: {\n    JEditableTable: JEditableTable,\n    'my-action-button': {\n      props: {\n        rowEvent: Object,\n        allowEmpty: Boolean\n      },\n      methods: {\n        confirmIsShow: function confirmIsShow() {\n          var _this$rowEvent = this.rowEvent,\n              index = _this$rowEvent.index,\n              inputValues = _this$rowEvent.allValues.inputValues;\n          var value = inputValues[index];\n          return value.digits || value.pattern;\n        },\n        handleLineAdd: function handleLineAdd() {\n          var target = this.rowEvent.target;\n          target.add();\n        },\n        handleLineDelete: function handleLineDelete() {\n          var _this$rowEvent2 = this.rowEvent,\n              rowId = _this$rowEvent2.rowId,\n              target = _this$rowEvent2.target;\n          target.removeRows(rowId);\n        },\n        renderDeleteButton: function renderDeleteButton() {\n          var h = this.$createElement;\n\n          if (this.allowEmpty || this.rowEvent.index > 0) {\n            if (this.confirmIsShow()) {\n              return h(\"a-popconfirm\", {\n                \"attrs\": {\n                  \"title\": \"确定要删除吗？\"\n                },\n                \"on\": {\n                  \"confirm\": this.handleLineDelete\n                }\n              }, [h(\"a-button\", {\n                \"attrs\": {\n                  \"icon\": \"minus\"\n                }\n              })]);\n            } else {\n              return h(\"a-button\", {\n                \"attrs\": {\n                  \"icon\": \"minus\"\n                },\n                \"on\": {\n                  \"click\": this.handleLineDelete\n                }\n              });\n            }\n          }\n\n          return '';\n        }\n      },\n      render: function render() {\n        var h = arguments[0];\n        return h(\"div\", [h(\"a-button\", {\n          \"on\": {\n            \"click\": this.handleLineAdd\n          },\n          \"attrs\": {\n            \"icon\": \"plus\"\n          }\n        }), \"\\xA0\", this.renderDeleteButton()]);\n      }\n    }\n  },\n  data: function data() {\n    var _this = this;\n\n    return {\n      title: '操作',\n      visible: false,\n      model: {},\n      labelCol: {\n        xs: {\n          span: 24\n        },\n        sm: {\n          span: 5\n        }\n      },\n      wrapperCol: {\n        xs: {\n          span: 24\n        },\n        sm: {\n          span: 16\n        }\n      },\n      confirmLoading: false,\n      form: this.$form.createForm(this),\n      validatorRules: {\n        ruleName: {\n          rules: [{\n            required: true,\n            message: '请输入规则名称!'\n          }]\n        },\n        ruleCode: {\n          rules: [{\n            required: true,\n            message: '请输入规则Code!'\n          }, {\n            validator: function validator(rule, value, callback) {\n              return validateDuplicateValue('sys_check_rule', 'rule_code', value, _this.model.id, callback);\n            }\n          }]\n        }\n      },\n      tabs: {\n        activeKey: 'design',\n        global: {\n          key: 'global',\n          columns: [{\n            title: '优先级',\n            key: 'priority',\n            width: '15%',\n            type: FormTypes.select,\n            defaultValue: '1',\n            options: [{\n              title: '优先运行',\n              value: '1'\n            }, {\n              title: '最后运行',\n              value: '0'\n            }],\n            validateRules: []\n          }, {\n            title: '规则（正则表达式）',\n            key: 'pattern',\n            width: '50%',\n            type: FormTypes.input,\n            validateRules: [{\n              required: true,\n              message: '规则不能为空'\n            }, {\n              handler: this.validatePatternHandler\n            }]\n          }, {\n            title: '提示文本',\n            key: 'message',\n            width: '20%',\n            type: FormTypes.input,\n            validateRules: [{\n              required: true,\n              message: '${title}不能为空'\n            }]\n          }, {\n            title: '操作',\n            key: 'action',\n            width: '15%',\n            slotName: 'action',\n            type: FormTypes.slot\n          }],\n          dataSource: []\n        },\n        design: {\n          key: 'design',\n          columns: [{\n            title: '位数',\n            key: 'digits',\n            width: '15%',\n            type: FormTypes.inputNumber,\n            validateRules: [{\n              required: true,\n              message: '${title}不能为空'\n            }, {\n              pattern: /^[1-9]\\d*$/,\n              message: '请输入零以上的正整数'\n            }]\n          }, {\n            title: '规则（正则表达式）',\n            key: 'pattern',\n            width: '50%',\n            type: FormTypes.input,\n            validateRules: [{\n              required: true,\n              message: '规则不能为空'\n            }, {\n              handler: this.validatePatternHandler\n            }]\n          }, {\n            title: '提示文本',\n            key: 'message',\n            width: '20%',\n            type: FormTypes.input,\n            validateRules: [{\n              required: true,\n              message: '${title}不能为空'\n            }]\n          }, {\n            title: '操作',\n            key: 'action',\n            width: '15%',\n            slotName: 'action',\n            type: FormTypes.slot\n          }],\n          dataSource: []\n        }\n      },\n      url: {\n        add: '/sys/checkRule/add',\n        edit: '/sys/checkRule/edit'\n      }\n    };\n  },\n  created: function created() {},\n  methods: {\n    validatePatternHandler: function validatePatternHandler(type, value, row, column, callback, target) {\n      if (type === 'blur' || type === 'getValues') {\n        try {\n          new RegExp(value);\n          callback(true);\n        } catch (e) {\n          callback(false, '请输入正确的正则表达式');\n        }\n      } else {\n        callback(true); // 不填写或者填写 null 代表不进行任何操作\n      }\n    },\n    add: function add() {\n      this.edit({});\n    },\n    edit: function edit(record) {\n      var _this2 = this;\n\n      this.form.resetFields();\n      this.tabs.activeKey = this.tabs.design.key;\n      this.tabs.global.dataSource = [];\n      this.tabs.design.dataSource = [{\n        digits: '',\n        pattern: '',\n        message: ''\n      }];\n      this.model = Object.assign({}, record);\n      this.visible = true;\n      this.$nextTick(function () {\n        _this2.form.setFieldsValue(pick(_this2.model, 'ruleName', 'ruleCode', 'ruleDescription')); // 子表数据\n\n\n        var ruleJson = _this2.model.ruleJson;\n\n        if (ruleJson) {\n          var ruleList = JSON.parse(ruleJson); // 筛选出全局规则和局部规则\n\n          var global = [],\n              design = [],\n              priority = '1';\n          ruleList.forEach(function (rule) {\n            if (rule.digits === '*') {\n              global.push(Object.assign(rule, {\n                priority: priority\n              }));\n            } else {\n              priority = '0';\n              design.push(rule);\n            }\n          });\n          _this2.tabs.global.dataSource = global;\n          _this2.tabs.design.dataSource = design;\n        }\n      });\n    },\n    close: function close() {\n      this.$emit('close');\n      this.visible = false;\n    },\n    handleOk: function handleOk() {\n      var _this3 = this;\n\n      Promise.all([// 主表单校验\n      alwaysResolve(new Promise(function (resolve, reject) {\n        _this3.form.validateFields(function (error, values) {\n          return error ? reject(error) : resolve(values);\n        });\n      })), // 局部规则子表校验\n      alwaysResolve(this.$refs.designTable.getValuesPromise), // 全局规则子表校验\n      alwaysResolve(this.$refs.globalTable.getValuesPromise)]).then(function (results) {\n        var _results = _slicedToArray(results, 3),\n            mainResult = _results[0],\n            designResult = _results[1],\n            globalResult = _results[2];\n\n        if (mainResult.type === failedSymbol) {\n          return Promise.reject('主表校验未通过');\n        } else if (designResult.type === failedSymbol) {\n          _this3.tabs.activeKey = _this3.tabs.design.key;\n          return Promise.reject('局部规则子表校验未通过');\n        } else if (globalResult.type === failedSymbol) {\n          _this3.tabs.activeKey = _this3.tabs.global.key;\n          return Promise.reject('全局规则子表校验未通过');\n        } else {\n          // 所有校验已通过，这一步是整合数据\n          var mainValues = mainResult.data,\n              globalValues = globalResult.data,\n              designValues = designResult.data; // 整合两个子表的数据\n\n          var firstGlobal = [],\n              afterGlobal = [];\n          globalValues.forEach(function (v) {\n            v.digits = '*';\n\n            if (v.priority === '1') {\n              firstGlobal.push(v);\n            } else {\n              afterGlobal.push(v);\n            }\n          });\n          var concatValues = firstGlobal.concat(designValues).concat(afterGlobal);\n          var subValues = concatValues.map(function (i) {\n            return pick(i, 'digits', 'pattern', 'message');\n          }); // 生成 formData，用于传入后台\n\n          var ruleJson = JSON.stringify(subValues);\n          var formData = Object.assign(_this3.model, mainValues, {\n            ruleJson: ruleJson\n          }); // 判断请求方式和请求地址，并发送请求\n\n          var method = 'post',\n              httpUrl = _this3.url.add;\n\n          if (_this3.model.id) {\n            method = 'put';\n            httpUrl = _this3.url.edit;\n          }\n\n          _this3.confirmLoading = true;\n          return httpAction(httpUrl, formData, method);\n        }\n      }).then(function (res) {\n        if (res.success) {\n          _this3.$message.success(res.message);\n\n          _this3.$emit('ok');\n\n          _this3.close();\n        } else {\n          _this3.$message.warning(res.message);\n        }\n      }).catch(function (e) {\n        console.error(e);\n      }).finally(function () {\n        _this3.confirmLoading = false;\n      });\n    },\n    handleCancel: function handleCancel() {\n      this.close();\n    }\n  }\n};",{"version":3,"sources":["SysCheckRuleModal.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <a-modal\n    :title=\"title\"\n    :width=\"1000\"\n    :visible=\"visible\"\n    :confirmLoading=\"confirmLoading\"\n    @ok=\"handleOk\"\n    @cancel=\"handleCancel\"\n    cancelText=\"关闭\">\n\n    <a-spin :spinning=\"confirmLoading\">\n      <a-form :form=\"form\">\n\n        <a-form-item\n          :labelCol=\"labelCol\"\n          :wrapperCol=\"wrapperCol\"\n          label=\"规则名称\">\n          <a-input placeholder=\"请输入规则名称\" v-decorator=\"['ruleName', validatorRules.ruleName]\"/>\n        </a-form-item>\n        <a-form-item\n          :labelCol=\"labelCol\"\n          :wrapperCol=\"wrapperCol\"\n          label=\"规则Code\">\n          <a-input placeholder=\"请输入规则Code\" v-decorator=\"['ruleCode', validatorRules.ruleCode]\"/>\n        </a-form-item>\n        <a-form-item\n          :labelCol=\"labelCol\"\n          :wrapperCol=\"wrapperCol\"\n          label=\"规则描述\">\n          <a-textarea placeholder=\"请输入规则描述\" v-decorator=\"['ruleDescription', {}]\"/>\n        </a-form-item>\n\n      </a-form>\n      <!-- 规则设计 -->\n      <a-tabs v-model=\"tabs.activeKey\">\n        <a-tab-pane tab=\"局部规则\" :key=\"tabs.design.key\" forceRender>\n          <a-alert type=\"info\" showIcon message=\"局部规则按照你输入的位数有序的校验。\"/>\n          <j-editable-table\n            ref=\"designTable\"\n            dragSort\n            rowNumber\n            :maxHeight=\"240\"\n            :columns=\"tabs.design.columns\"\n            :dataSource=\"tabs.design.dataSource\"\n            style=\"margin-top: 8px;\"\n          >\n\n            <template #action=\"props\">\n              <my-action-button :rowEvent=\"props\"/>\n            </template>\n\n          </j-editable-table>\n        </a-tab-pane>\n        <a-tab-pane tab=\"全局规则\" :key=\"tabs.global.key\" forceRender>\n          <j-editable-table\n            ref=\"globalTable\"\n            dragSort\n            rowNumber\n            actionButton\n            :maxHeight=\"240\"\n            :columns=\"tabs.global.columns\"\n            :dataSource=\"tabs.global.dataSource\"\n          >\n\n            <template #actionButtonAfter>\n              <a-alert type=\"info\" showIcon message=\"全局规则可校验用户输入的所有字符；全局规则的优先级比局部规则的要高。\" style=\"margin-bottom: 8px;\"/>\n            </template>\n\n            <template #action=\"props\">\n              <my-action-button :rowEvent=\"props\" allowEmpty/>\n            </template>\n\n          </j-editable-table>\n        </a-tab-pane>\n      </a-tabs>\n    </a-spin>\n  </a-modal>\n</template>\n\n<script>\n  import pick from 'lodash.pick'\n  import { httpAction } from '@/api/manage'\n  import { validateDuplicateValue, alwaysResolve, failedSymbol } from '@/utils/util'\n  import { FormTypes } from '@/utils/JEditableTableUtil'\n  import JEditableTable from '@comp/jeecg/JEditableTable'\n\n  export default {\n    name: 'SysCheckRuleModal',\n    components: {\n      JEditableTable,\n      'my-action-button': {\n        props: { rowEvent: Object, allowEmpty: Boolean },\n        methods: {\n          confirmIsShow() {\n            const { index, allValues: { inputValues } } = this.rowEvent\n            let value = inputValues[index]\n            return value.digits || value.pattern\n          },\n          handleLineAdd() {\n            const { target } = this.rowEvent\n            target.add()\n          },\n          handleLineDelete() {\n            const { rowId, target } = this.rowEvent\n            target.removeRows(rowId)\n          },\n          renderDeleteButton() {\n            if (this.allowEmpty || this.rowEvent.index > 0) {\n              if (this.confirmIsShow()) {\n                return (\n                  <a-popconfirm title=\"确定要删除吗？\" onConfirm={this.handleLineDelete}>\n                    <a-button icon=\"minus\"/>\n                  </a-popconfirm>\n                )\n              } else {\n                return (\n                  <a-button icon=\"minus\" onClick={this.handleLineDelete}/>\n                )\n              }\n            }\n            return ''\n          },\n        },\n        render() {\n          return (\n            <div>\n              <a-button onClick={this.handleLineAdd} icon=\"plus\"/>\n              &nbsp;\n              {this.renderDeleteButton()}\n            </div>\n          )\n        }\n      }\n    },\n    data() {\n      return {\n        title: '操作',\n        visible: false,\n        model: {},\n        labelCol: {\n          xs: { span: 24 },\n          sm: { span: 5 },\n        },\n        wrapperCol: {\n          xs: { span: 24 },\n          sm: { span: 16 },\n        },\n        confirmLoading: false,\n        form: this.$form.createForm(this),\n        validatorRules: {\n          ruleName: { rules: [{ required: true, message: '请输入规则名称!' },] },\n          ruleCode: {\n            rules: [\n              { required: true, message: '请输入规则Code!' },\n              { validator: (rule, value, callback) => validateDuplicateValue('sys_check_rule', 'rule_code', value, this.model.id, callback) }\n            ]\n          },\n        },\n        tabs: {\n          activeKey: 'design',\n          global: {\n            key: 'global',\n            columns: [\n              {\n                title: '优先级',\n                key: 'priority',\n                width: '15%',\n                type: FormTypes.select,\n                defaultValue: '1',\n                options: [\n                  { title: '优先运行', value: '1' },\n                  { title: '最后运行', value: '0' },\n                ],\n                validateRules: []\n              },\n              {\n                title: '规则（正则表达式）',\n                key: 'pattern',\n                width: '50%',\n                type: FormTypes.input,\n                validateRules: [\n                  { required: true, message: '规则不能为空' },\n                  { handler: this.validatePatternHandler },\n                ]\n              },\n              {\n                title: '提示文本',\n                key: 'message',\n                width: '20%',\n                type: FormTypes.input,\n                validateRules: [\n                  { required: true, message: '${title}不能为空' },\n                ]\n              },\n              {\n                title: '操作',\n                key: 'action',\n                width: '15%',\n                slotName: 'action',\n                type: FormTypes.slot\n              }\n            ],\n            dataSource: [],\n          },\n          design: {\n            key: 'design',\n            columns: [\n              {\n                title: '位数',\n                key: 'digits',\n                width: '15%',\n                type: FormTypes.inputNumber,\n                validateRules: [\n                  { required: true, message: '${title}不能为空' },\n                  { pattern: /^[1-9]\\d*$/, message: '请输入零以上的正整数' },\n                ]\n              },\n              {\n                title: '规则（正则表达式）',\n                key: 'pattern',\n                width: '50%',\n                type: FormTypes.input,\n                validateRules: [\n                  { required: true, message: '规则不能为空' },\n                  { handler: this.validatePatternHandler }\n                ]\n              },\n              {\n                title: '提示文本',\n                key: 'message',\n                width: '20%',\n                type: FormTypes.input,\n                validateRules: [\n                  { required: true, message: '${title}不能为空' },\n                ]\n              },\n              {\n                title: '操作',\n                key: 'action',\n                width: '15%',\n                slotName: 'action',\n                type: FormTypes.slot\n              },\n            ],\n            dataSource: [],\n          }\n        },\n        url: {\n          add: '/sys/checkRule/add',\n          edit: '/sys/checkRule/edit',\n        },\n      }\n    },\n    created() {\n    },\n    methods: {\n\n      validatePatternHandler(type, value, row, column, callback, target) {\n        if (type === 'blur' || type === 'getValues') {\n          try {\n            new RegExp(value)\n            callback(true)\n          } catch (e) {\n            callback(false, '请输入正确的正则表达式')\n          }\n        } else {\n          callback(true) // 不填写或者填写 null 代表不进行任何操作\n        }\n      },\n\n      add() {\n        this.edit({})\n      },\n      edit(record) {\n        this.form.resetFields()\n        this.tabs.activeKey = this.tabs.design.key\n        this.tabs.global.dataSource = []\n        this.tabs.design.dataSource = [{ digits: '', pattern: '', message: '' }]\n        this.model = Object.assign({}, record)\n        this.visible = true\n        this.$nextTick(() => {\n          this.form.setFieldsValue(pick(this.model, 'ruleName', 'ruleCode', 'ruleDescription'))\n          // 子表数据\n          let ruleJson = this.model.ruleJson\n          if (ruleJson) {\n            let ruleList = JSON.parse(ruleJson)\n            // 筛选出全局规则和局部规则\n            let global = [], design = [], priority = '1'\n            ruleList.forEach(rule => {\n              if (rule.digits === '*') {\n                global.push(Object.assign(rule, { priority }))\n              } else {\n                priority = '0'\n                design.push(rule)\n              }\n            })\n            this.tabs.global.dataSource = global\n            this.tabs.design.dataSource = design\n          }\n        })\n      },\n      close() {\n        this.$emit('close')\n        this.visible = false\n      },\n      handleOk() {\n        Promise.all([\n          // 主表单校验\n          alwaysResolve(new Promise((resolve, reject) => {\n            this.form.validateFields((error, values) => error ? reject(error) : resolve(values))\n          })),\n          // 局部规则子表校验\n          alwaysResolve(this.$refs.designTable.getValuesPromise),\n          // 全局规则子表校验\n          alwaysResolve(this.$refs.globalTable.getValuesPromise),\n        ]).then(results => {\n          let [mainResult, designResult, globalResult] = results\n\n          if (mainResult.type === failedSymbol) {\n            return Promise.reject('主表校验未通过')\n          } else if (designResult.type === failedSymbol) {\n            this.tabs.activeKey = this.tabs.design.key\n            return Promise.reject('局部规则子表校验未通过')\n          } else if (globalResult.type === failedSymbol) {\n            this.tabs.activeKey = this.tabs.global.key\n            return Promise.reject('全局规则子表校验未通过')\n          } else {\n            // 所有校验已通过，这一步是整合数据\n            let mainValues = mainResult.data, globalValues = globalResult.data, designValues = designResult.data\n\n            // 整合两个子表的数据\n            let firstGlobal = [], afterGlobal = []\n            globalValues.forEach(v => {\n              v.digits = '*'\n              if (v.priority === '1') {\n                firstGlobal.push(v)\n              } else {\n                afterGlobal.push(v)\n              }\n            })\n            let concatValues = firstGlobal.concat(designValues).concat(afterGlobal)\n            let subValues = concatValues.map(i => pick(i, 'digits', 'pattern', 'message'))\n\n            // 生成 formData，用于传入后台\n            let ruleJson = JSON.stringify(subValues)\n            let formData = Object.assign(this.model, mainValues, { ruleJson })\n\n            // 判断请求方式和请求地址，并发送请求\n            let method = 'post', httpUrl = this.url.add\n            if (this.model.id) {\n              method = 'put'\n              httpUrl = this.url.edit\n            }\n            this.confirmLoading = true\n            return httpAction(httpUrl, formData, method)\n          }\n        }).then((res) => {\n          if (res.success) {\n            this.$message.success(res.message)\n            this.$emit('ok')\n            this.close()\n          } else {\n            this.$message.warning(res.message)\n          }\n        }).catch(e => {\n          console.error(e)\n        }).finally(() => {\n          this.confirmLoading = false\n        })\n      },\n      handleCancel() {\n        this.close()\n      },\n\n    }\n  }\n</script>\n\n<style lang=\"less\" scoped></style>"],"sourceRoot":"src/views/system/modules"}]}